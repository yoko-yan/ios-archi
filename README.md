# ios-archi

技術的な検証など自由に試すためのiOSアプリケーションプレイグラウンド

> お試し用のプロジェクトなので、あえてレガシーな技術を使っていたり、悪いコードで書いていたりしています。
> レガシーな技術を使っていたり悪いコードで書いているところは、挙動を確認したりリファクタの方法を試したりするのが主な目的です。

<img src="App/ios-archi/Assets.xcassets/AppIcon.appiconset/AppIcon.png" width="100">

## プロジェクト構成

### マルチモジュールアーキテクチャ

Swift Package Managerを使用したモジュール構成:

- **`Package/`**: 全機能モジュールと共有ライブラリ
  - **`Core`**: DIコンテナ（`InjectedValues`）とビルドヘルパーを含む基盤モジュール
  - **`Analytics`**: アナリティクスサービスのプロトコル定義
  - **`AnalyticsImpl`**: Firebase Analytics実装
  - **`AppFeature`**: メイン機能モジュール（レイヤードアーキテクチャ）
    - `Domain/`: ユースケース層
    - `Data/`: データ層（Repository, DataSource, Request）
    - `UI/`: SwiftUIビュー（機能ごとに整理）
    - `Model/`: ドメインモデル
    - `Extension/`: Swift拡張
    - `CodeGenerated/`: Sourceryによる自動生成コード（モック、DI）

- **`App/ios-archi/`**: メインアプリケーションターゲット
  - アプリエントリーポイント（`ios_archiApp.swift`）と`AppDelegate`
  - `XCConfigs/`でビルド設定を管理
  - Packageモジュールを依存関係として使用

### ディレクトリ構造

```
ios-archi_/
├── App/
│   └── ios-archi.xcodeproj  # アプリケーションプロジェクト
├── Package/                  # 機能モジュール群
│   ├── Sources/
│   │   ├── Core/
│   │   ├── Analytics/
│   │   ├── AnalyticsImpl/
│   │   └── AppFeature/
│   └── Tests/
└── Tools/
    └── Package.swift         # 開発ツール（SwiftLint, SwiftFormat, Sourcery）
```

## セットアップ

### 初回セットアップ

```bash
make bootstrap
```

このコマンドで以下が実行されます:
1. SPM経由でツール依存関係を解決
2. プロジェクトを開く

### ビルド

```bash
# プロジェクトのビルド
xcodebuild -workspace ios-archi.xcworkspace -scheme ios-archi build

# テスト用ビルド
xcodebuild -workspace ios-archi.xcworkspace -scheme ios-archi build-for-testing

# テスト実行
xcodebuild -workspace ios-archi.xcworkspace -scheme ios-archi test
```

### コード品質ツール

```bash
# SwiftLint実行
make lint

# SwiftLint自動修正
make lint-fix

# SwiftFormat実行
make format

# Sourceryでコード生成（モック、DI）
make sourcery
```

または、直接SPM経由で実行:

```bash
swift run --package-path Tools swiftlint
swift run --package-path Tools swiftformat .
swift run --package-path Tools sourcery --config .sourcery.yml
```

## アーキテクチャ

### MVVM + レイヤードアーキテクチャ

- **UI層**: SwiftUIによるビュー（`Package/Sources/AppFeature/UI/`）
- **Domain層**: ユースケース（`Package/Sources/AppFeature/Domain/`）
- **Data層**: Repository, DataSource（`Package/Sources/AppFeature/Data/`）

### 依存性注入（DI）

カスタムプロパティラッパーベースのDIコンテナ（`Core/InjectedValues.swift`）を使用:

```swift
// 注入キーの定義
extension InjectedValues {
    var myService: MyService {
        get { Self[MyServiceKey.self] }
        set { Self[MyServiceKey.self] = newValue }
    }
}

// コード内での使用
@Injected(\.myService) var myService
```

### コード生成（Sourcery）

以下のプロトコルでコード生成を自動化:
- **`AutoMockable`**: テストモックを生成（`CodeGenerated/AutoGeneratedMocks.swift`）
- **`AutoInjectable`**: DI登録コードを生成（`CodeGenerated/AutoInjectableValues.swift`）

### テスト

- **フレームワーク**: Quick/Nimble（BDDスタイル）
- **ロケーション**: `Package/Tests/AppFeatureTests/`
- **命名規則**: `Spec`サフィックス（例: `RootViewModelSpec.swift`）
- **依存管理**: swift-dependencies
- **モック**: Sourceryによる自動生成

## 使用技術

### 現在使用中

- iOS 17+, Swift 5.9+
- MVVM + レイヤードアーキテクチャ
- SwiftUI
- Combine
- Swift Concurrency
- CoreData
- CloudKit（データ同期）
- VisionFramework
- WebKit
- Firebase Analytics
- Firebase Crashlytics
- Swift Package Manager（マルチモジュール構成）
- DIコンテナ（カスタム実装）
- swift-dependencies
- ドメイン駆動設計（DDD）戦術的設計
- Quick/Nimble（テスト）
- SwiftLint
- SwiftFormat
- Sourcery（コード生成）
- XCConfig
- Xcode Cloud
- Xcode Preview
- bundler
- rbenv

### 導入予定

- APIKit
- Renovate（ライブラリの自動更新）
- Cloud Vision API
- エラーハンドラー
- PageObjectデザインパターン（UIテスト）
- Firebase Cloud Messaging
- Firebase Remote Config
- GitHub Actions
- DangerSwift

### 今後使いたい技術

- MLKit
- TCA（マルチモジュール）

※ 作りたいアプリのイメージをベースにリストアップしているが、それ以外にも使いたい技術はある

## 設定ファイル

- **`.swiftlint.yml`**: SwiftLintルール設定
- **`.swiftformat`**: SwiftFormat設定（4スペースインデント、アルファベット順インポート）
- **`.sourcery.yml`**: Sourceryコード生成設定
- **`Package/Package.swift`**: SPMパッケージ定義（strict concurrency有効）
- **`Tools/Package.swift`**: 開発ツール定義
- **`App/ios-archi/XCConfigs/`**: ビルド設定（Base, Debug, Release, Local）

## Firebase設定

### GoogleService-Info.plistの配置

Firebaseを使用するため、GoogleService-Infoファイルを手動で配置する必要があります（.gitignoreで除外されているため）。

1. [Firebaseコンソール](https://console.firebase.google.com/)からプロジェクトの設定ファイルをダウンロード
2. 以下のディレクトリに配置:

```
App/ios-archi/Configs/
├── GoogleService-Info-Debug.plist    # Debug用
└── GoogleService-Info-Release.plist  # Release用
```

> **注意**: これらのファイルにはAPIキーなどの機密情報が含まれるため、gitにコミットしないでください。

## Xcode Cloud設定

Xcode Cloudでビルドする場合、環境変数を使用して設定ファイルを生成します。

### 環境変数の設定

Xcode Cloudの「Environment Variables」で以下の変数をSecretとして登録:

| 変数名 | 説明 |
|--------|------|
| `XCCONFIG` | Local.xcconfigをbase64エンコードした値 |
| `GOOGLE_SERVICE_INFO` | GoogleService-Info-Release.plistをbase64エンコードした値 |
| `GOOGLE_SERVICE_INFO_DEBUG` | GoogleService-Info-Debug.plistをbase64エンコードした値 |

### base64エンコードの方法

```bash
# Local.xcconfigをエンコード
cat App/ios-archi/XCConfigs/Local.xcconfig | base64

# GoogleService-Info-Release.plistをエンコード
cat App/ios-archi/Configs/GoogleService-Info-Release.plist | base64

# GoogleService-Info-Debug.plistをエンコード
cat App/ios-archi/Configs/GoogleService-Info-Debug.plist | base64
```

### ci_post_clone.sh

`ci_scripts/ci_post_clone.sh`がクローン後に実行され、環境変数から設定ファイルを生成します:

- Swift MacrosとSPMプラグインのビルドエラー回避設定
- Local.xcconfigの生成
- GoogleService-Info-*.plistの生成

## VS Code統合

`buildServer.json`を使用した`xcode-build-server`統合:
- ワークスペース: `ios-archi.xcworkspace`
- スキーム: `ios-archi`
